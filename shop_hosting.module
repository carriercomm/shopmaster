<?php
/**
 */

/**
 * Implements hook_form_alter().
 */
function shop_hosting_form_alter(&$form, &$form_state, $form_id){

}

function shop_hosting_hosting_tasks_alter(&$tasks) {
}


function shop_hosting_nodeapi_server_load(&$node){
  
  // Build attributes object
  $node->attributes = new stdClass;

  // Add server users: any users with role "administrator"
  $admin_role = variable_get('shop_server_admin_role', 'administrator');
  $admins = db_query('SELECT u.name, u.uid FROM users u LEFT JOIN users_roles ur on u.uid = ur.uid LEFT JOIN role r ON ur.rid = r.rid WHERE r.name = "%s" OR u.uid = 1 OR u.uid = %d', $admin_role, $node->uid);
  while ($account = db_fetch_object($admins)){
    $keys = sshkey_load_all_by_entity('user', $node->uid);
    $account->ssh_keys = array();
    foreach ($keys as $key){
      $ssh_keys[] = $key->value;
      $account->ssh_keys[] = $key->value;
    }
    // Adding each users authorized key.
    $node->attributes->devudo['users'][$account->name] = implode("\n", $account->ssh_keys);
  }
  
  // Authorized Keys to add to aegir user
  $node->attributes->aegir['authorized_keys'] = implode("\n", $ssh_keys);
  
  // @TODO: Allow tracking of users to grant account

}

function shop_hosting_nodeapi_server_view(&$node){
  
  foreach ($node->attributes as $name => $value) {
    if (is_array($value)){
      foreach($value as $sub_name => $sub_value){
        $node->content['info']['attributes'][$sub_name] = array(
          '#type' => 'item',
          '#title' => "$name:$sub_name",
          '#value' => json_encode($sub_value),
        );  
      }
    } elseif (is_string($value)) {
      $node->content['info']['attributes'] = array(
        '#type' => 'item',
        '#title' => $name,
        '#value' => json_encode($value),
      ); 
    }
    
  }
  
}